<div class="app-container d-flex flex-column h-100" #conversationListDiv>

  <h3 class="view-title">Chats</h3>
  <div class="d-flex buttons-wrapper mb-2">
    <div class="tab-button text-center py-2"
         matRipple [matRippleColor]="'rgba(0, 0, 0, .14)'"
         [ngClass]="{'active' : isGroupChatOnly}" (click)="setGroupChatOnly(true)">
      <div>Groups</div>
      <div class="badge" *ngIf="groupsUnreadCount > 0">
        {{ groupsUnreadCount }}
      </div>
    </div>
    <div class="tab-button text-center py-2"
         matRipple [matRippleColor]="'rgba(0, 0, 0, .14)'"
         [ngClass]="{'active' : !isGroupChatOnly}" (click)="setGroupChatOnly(false)">
      <div>Users</div>
      <div class="badge" *ngIf="usersUnreadCount > 0">
        {{ usersUnreadCount }}
      </div>
    </div>
  </div>

  <div class="chat-list flex-grow-1 overflow-y-overlay" (scroll)="onScroll()" #scrollWrapperDiv>
    <!--  <div>-->
    <!--    <button class="my-btn btn-background" (click)="onContacts()">Contacts</button>-->
    <!--  </div>-->
    <div class="w-100">
      <div class="search-wrapper">
        <span class="me-2"><fa-icon [icon]="faMagnifyingGlass" /></span>
        <input placeholder="Search" type="text" (keyup)="onSearchInputKeyPress($event)"
               #searchInput>

      </div>
      <!--    <button class="my-btn purple-btn search-btn ms-2" (click)="applySearchFilter()">Search</button>-->
    </div>
    <div *ngFor="let conversation of showingConversations" (click)="onConversation(conversation)" #scrollDiv>
      <div class="d-flex mt-2 mt-2 item-wrapper align-items-center">
        <div class="media-wrapper d-flex justify-content-center align-items-center">

          <ng-container *ngIf="conversation.user?.type === UserType.user && conversation.pin > 0">
            <img class="img-fluid simorq-img" src="assets/img/login_logo.png">
          </ng-container>
          <ng-container *ngIf="conversation.user?.type === UserType.user && conversation.pin === 0">
            <div class="w-100 h-100 d-flex justify-content-center align-items-center">
              <div class="d-flex justify-content-center align-items-center media-text"
                   *ngIf="!conversation.user?.media_id">
                {{ getHeaderName(conversation) }}
              </div>
              <img class="w-100 h-100 object-fit-cover" src="{{getPhotoSrc(conversation.user)}}"
                   *ngIf="conversation.user?.media_id">
            </div>
          </ng-container>
          <ng-container
            *ngIf="conversation.user?.type === UserType.group || conversation.user?.type === UserType.channel">
            <img class="img-fluid simorq-img" src="assets/img/login_logo.png">
          </ng-container>
        </div>
        <div class="flex-grow-1 h-100 d-flex flex-column justify-content-center ms-2 flex-shrink-1">
          <div class="d-flex name-text align-items-center">
            <span>{{ conversation.user?.first_name ?? '' }} {{ conversation.user?.last_name ?? '' }}</span>
          </div>
          <div class="d-flex align-items-center">
            <div class="in-group-name-text flex-shrink-0" *ngIf="conversation.user?.type === UserType.group">
              <ng-container *ngIf="getSenderUser(conversation.last_message?.to_id) as senderUser">
                <ng-container *ngIf="senderUser.id !== selfId; else showYou">
                  <span>{{ senderUser?.first_name ?? '' }} {{ senderUser?.last_name ?? '' }}</span>
                </ng-container>
                <ng-template #showYou>
                  <span>You</span>
                </ng-template>
                <span> :</span>
              </ng-container>
            </div>

            <div class="message-text"
                 [ngClass]="{'in-group': conversation.user?.type === UserType.group}">
              <app-twemoji-text-module [isOneLine]="true"
                                       [value]="getMessageSummary(conversation.last_message,conversation,getSenderUser(conversation.last_message?.to_id))"></app-twemoji-text-module>
            </div>
          </div>
        </div>
        <div class="h-100 d-flex flex-column align-items-end justify-content-end flex-shrink-0">
          <div class="d-flex align-items-center justify-content-end message-status-wrapper">

            <span class="message-status ps-1" *ngIf="conversation.last_message?.is_sender">
                      <ng-container *ngIf="conversation?.last_message?.is_local">
                        <img class="d-block dialog-pending" src="assets/img/pending.png">
                      </ng-container>
                      <ng-container
                        *ngIf="!conversation?.last_message?.is_local && (conversation.last_read_counter < (conversation.last_message?.conversation_counter ?? 0))">
                        <img class="d-block dialog-check" src="assets/img/dialogs_check.png">
                      </ng-container>
                      <ng-container
                        *ngIf="!conversation?.last_message?.is_local && (conversation.last_read_counter >= (conversation.last_message?.conversation_counter ?? 0))">
                        <img class="d-block dialog-read" src="assets/img/dialogs_read.png">
                      </ng-container>
                    </span>
            <div class="date-text ps-1">
              {{ getMessageTime(conversation.last_message?.creation_date) }}
            </div>
          </div>
          <ng-container
            *ngIf="conversation.user?.type === UserType.user && ( conversation.last_message_counter - conversation.last_seen_counter > 0);else notUserUnread"
          >
            <div class="unread-counter">
              {{ conversation.last_message_counter - conversation.last_seen_counter }}
            </div>
          </ng-container>
          <ng-template #notUserUnread>
            <ng-container
              *ngIf="conversation.user?.type === UserType.group && conversation.user_group && (conversation.last_message_counter - conversation.user_group.last_seen_counter > 0);else notGroupUnread"
            >
              <div class="unread-counter">
                {{ conversation.last_message_counter - conversation.user_group.last_seen_counter }}
              </div>
            </ng-container>
            <ng-template #notGroupUnread>
              &nbsp;
            </ng-template>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</div>
